<div class="account-page">
  @if (user(); as currentUser) {
    <mat-card class="profile-card">
      <mat-card-header>
        <div class="header-content">
          <div class="header-left">
            <mat-icon class="profile-icon">account_circle</mat-icon>
            <div class="header-text">
              <mat-card-title>My Account</mat-card-title>
              <mat-card-subtitle>Manage your profile information</mat-card-subtitle>
            </div>
          </div>
          <mat-chip [color]="getRoleBadgeColor(currentUser.role)" highlighted>
            {{ getRoleDisplayName(currentUser.role) }}
          </mat-chip>
        </div>
      </mat-card-header>

      <mat-divider />

      <mat-card-content>
        <!-- Profile Information -->
        <app-profile-info
          [profileForm]="profileForm"
          [isEditMode]="isEditMode()"
        />

        <mat-divider class="section-divider" />

        <!-- Payment Methods -->
        <app-saved-payment-methods-manager
          [savedPaymentMethods]="savedPaymentMethods()"
          [selectedPaymentMethodId]="selectedPaymentMethodId()"
          [showPaymentMethodForm]="showPaymentMethodForm()"
          [paymentMethodForm]="paymentMethodForm"
          [selectedPaymentType]="selectedPaymentType()"
          (paymentMethodSelectionChange)="onPaymentMethodSelectionChange($event)"
          (toggleForm)="togglePaymentMethodForm()"
          (paymentTypeChange)="onPaymentTypeChange($event)"
          (savePaymentMethod)="savePaymentMethod()"
          (deleteSelected)="deleteSelectedPaymentMethod()"
          (setAsDefault)="setSelectedPaymentMethodAsDefault()"
        />

        <mat-divider class="section-divider" />

        <!-- Shipping Addresses -->
        <app-saved-addresses-manager
          [savedAddresses]="savedAddresses()"
          [selectedAddressId]="selectedAddressId()"
          [showAddressForm]="showAddressForm()"
          [addressForm]="addressForm"
          (addressSelectionChange)="onAddressSelectionChange($event)"
          (toggleForm)="toggleAddressForm()"
          (saveAddress)="saveAddress()"
          (deleteSelected)="deleteSelectedAddress()"
          (setAsDefault)="setSelectedAddressAsDefault()"
        />
      </mat-card-content>

      <mat-divider />

      <mat-card-actions class="card-actions">
        @if (!isEditMode()) {
          <button mat-raised-button color="primary" (click)="toggleEditMode()">
            <mat-icon>edit</mat-icon>
            Edit Profile
          </button>
        } @else {
          <button mat-button (click)="toggleEditMode()">
            Cancel
          </button>
          <button 
            mat-raised-button 
            color="primary" 
            (click)="saveProfile()"
            [disabled]="!profileForm.valid"
          >
            <mat-icon>save</mat-icon>
            Save Changes
          </button>
        }
      </mat-card-actions>
    </mat-card>

    <!-- Account Stats -->
    <app-account-stats
      [totalOrders]="totalOrders()"
      [totalSpent]="totalSpent()"
      [loyaltyPoints]="loyaltyPoints()"
    />
  } @else {
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon>error_outline</mat-icon>
        <p>Unable to load account information. Please log in.</p>
      </mat-card-content>
    </mat-card>
  }
</div>
