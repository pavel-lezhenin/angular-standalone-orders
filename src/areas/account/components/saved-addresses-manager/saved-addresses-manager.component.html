<div class="addresses-section">
  <div class="section-header">
    <h3>Shipping Addresses</h3>
    <button
      mat-raised-button
      color="primary"
      (click)="toggleForm.emit()"
    >
      @if (showAddressForm()) {
        <ng-container>
          <mat-icon>close</mat-icon>
          Cancel
        </ng-container>
      } @else {
        <ng-container>
          <mat-icon>add</mat-icon>
          Add Address
        </ng-container>
      }
    </button>
  </div>

  @if (!showAddressForm()) {
    <div class="selection-controls">
      <app-form-field
        [label]="'Selected Address'"
        [control]="addressSelectControl"
        [type]="'select'"
        [fieldClass]="'address-select'"
      >
        @for (address of savedAddresses(); track address.id) {
          <mat-option [value]="address.id">
            {{ address.label }}
            @if (address.isDefault) {
              (Default)
            }
          </mat-option>
        }
      </app-form-field>

      <div class="action-buttons">
        @if (canSetAsDefault()) {
          <button
            mat-stroked-button
            color="primary"
            (click)="setAsDefault.emit()"
          >
            Set as Default
          </button>
        }

        @if (canDeleteSelected()) {
          <button
            mat-stroked-button
            color="warn"
            (click)="deleteSelected.emit()"
          >
            <mat-icon>delete</mat-icon>
            Delete
          </button>
        }
      </div>
    </div>

    @if (selectedAddress(); as address) {
      <div class="selected-address-display">
        <div class="address-details">
          <p><strong>{{ address.label }}</strong></p>
          <p>{{ address.recipientName }}</p>
          <p>{{ address.addressLine1 }}</p>
          @if (address.addressLine2) {
            <p>{{ address.addressLine2 }}</p>
          }
          <p>{{ address.city }}, {{ address.postalCode }}</p>
          <p>{{ address.phone }}</p>
        </div>
      </div>
    }
  } @else {
    <form [formGroup]="addressForm()" class="address-form">
      <div class="form-row">
        <app-form-field
          [label]="'Label'"
          [control]="$any(addressForm().controls['label'])"
          [placeholder]="'e.g., Home, Work'"
        />

        <app-form-field
          [label]="'Recipient Name'"
          [control]="$any(addressForm().controls['recipientName'])"
        />
      </div>

      <app-form-field
        [label]="'Address Line 1'"
        [control]="$any(addressForm().controls['addressLine1'])"
        [fieldClass]="'full-width'"
      />

      <app-form-field
        [label]="'Address Line 2 (Optional)'"
        [control]="$any(addressForm().controls['addressLine2'])"
        [fieldClass]="'full-width'"
      />

      <div class="form-row">
        <app-form-field
          [label]="'City'"
          [control]="$any(addressForm().controls['city'])"
        />

        <app-form-field
          [label]="'Postal Code'"
          [control]="$any(addressForm().controls['postalCode'])"
        />
      </div>

      <app-form-field
        [label]="'Phone'"
        [control]="$any(addressForm().controls['phone'])"
        [type]="'tel'"
        [fieldClass]="'full-width'"
      />

      <div class="form-actions">
        <button
          mat-raised-button
          color="primary"
          type="button"
          [disabled]="addressForm().invalid"
          (click)="saveAddress.emit()"
        >
          Save Address
        </button>
      </div>
    </form>
  }
</div>
