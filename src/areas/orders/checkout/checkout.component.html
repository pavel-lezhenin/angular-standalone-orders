<div class="checkout-page">
  <div class="checkout-container">
    <h1>Checkout</h1>

    <app-page-loader [isLoading]="loading()" />

    @if (hasLoaded() && isEmpty()) {
      <app-empty-state
        [icon]="'shopping_cart'"
        [title]="'Your cart is empty'"
        [message]="'Please add items to cart before checkout.'"
        [actionLabel]="'Go to Shop'"
        (action)="goToShop()"
      />
    } @else if (hasLoaded()) {
      <div class="checkout-content">
        <!-- Left Column: Delivery Form -->
        <div class="delivery-section">
          <form [formGroup]="checkoutForm" class="delivery-form">
            <!-- Guest Account Creation Section -->
            @if (isGuest()) {
              <div class="account-section">
                <h2>Account Information</h2>
                <p class="section-description">Create an account to track your order</p>

                <!-- Email -->
                <app-form-field
                  [label]="'Email'"
                  [control]="$any(checkoutForm.controls['email'])"
                  [type]="'email'"
                  [placeholder]="'john.doe@example.com'"
                  [prefixIcon]="'email'"
                  [fieldClass]="'form-field'"
                />

                <!-- Password -->
                <app-form-field
                  [label]="'Password'"
                  [control]="$any(checkoutForm.controls['password'])"
                  [type]="'password'"
                  [placeholder]="'••••••••'"
                  [prefixIcon]="'lock'"
                  [fieldClass]="'form-field'"
                />

                <!-- First Name -->
                <app-form-field
                  [label]="'First Name'"
                  [control]="$any(checkoutForm.controls['firstName'])"
                  [placeholder]="'John'"
                  [prefixIcon]="'person'"
                  [fieldClass]="'form-field'"
                />

                <!-- Last Name -->
                <app-form-field
                  [label]="'Last Name'"
                  [control]="$any(checkoutForm.controls['lastName'])"
                  [placeholder]="'Doe'"
                  [prefixIcon]="'person_outline'"
                  [fieldClass]="'form-field'"
                />

                <!-- Login Link -->
                <div class="login-link-container">
                  <p>Already have an account? <a routerLink="/auth/login" [queryParams]="{returnUrl: '/orders/checkout'}">Login</a></p>
                </div>
              </div>
            }

            <!-- Delivery Information Section -->
            <div class="address-section">
              <h2>Delivery Information</h2>

              @if (!isGuest() && hasSavedAddresses()) {
                <div class="saved-address-controls">
                  <app-form-field
                    [label]="'Delivery Address'"
                    [control]="$any(checkoutForm.controls['selectedAddressId'])"
                    [type]="'select'"
                    [prefixIcon]="'bookmark'"
                    [fieldClass]="'form-field'"
                    [selectOptions]="addressSelectOptions()"
                  />

                  <button
                    mat-stroked-button
                    type="button"
                    (click)="toggleAddressForm()">
                    @if (showAddressForm()) {
                      Use Saved Address
                    } @else {
                      Add New Address
                    }
                  </button>
                </div>
              }

              @if (!isGuest() && shouldShowAddressForm()) {
                <!-- Full Name (authenticated users only) -->
                <app-form-field
                  [label]="'Full Name'"
                  [control]="$any(checkoutForm.controls['fullName'])"
                  [placeholder]="'John Doe'"
                  [prefixIcon]="'person'"
                  [fieldClass]="'form-field'"
                />
              }

              @if (shouldShowAddressForm()) {
                <!-- Address Line 1 -->
                <app-form-field
                  [label]="'Address Line 1'"
                  [control]="$any(checkoutForm.controls['addressLine1'])"
                  [placeholder]="'123 Main Street'"
                  [prefixIcon]="'home'"
                  [fieldClass]="'form-field'"
                />

                <!-- Address Line 2 -->
                <app-form-field
                  [label]="'Address Line 2 (Optional)'"
                  [control]="$any(checkoutForm.controls['addressLine2'])"
                  [placeholder]="'Apt, Suite, etc.'"
                  [prefixIcon]="'apartment'"
                  [fieldClass]="'form-field'"
                />

                <!-- City -->
                <app-form-field
                  [label]="'City'"
                  [control]="$any(checkoutForm.controls['city'])"
                  [placeholder]="'New York'"
                  [prefixIcon]="'location_city'"
                  [fieldClass]="'form-field'"
                />

                <!-- Postal Code -->
                <app-form-field
                  [label]="'Postal Code'"
                  [control]="$any(checkoutForm.controls['postalCode'])"
                  [placeholder]="'12345'"
                  [prefixIcon]="'markunread_mailbox'"
                  [fieldClass]="'form-field'"
                />

                <!-- Phone -->
                <app-form-field
                  [label]="'Phone Number'"
                  [control]="$any(checkoutForm.controls['phone'])"
                  [placeholder]="'+1 (555) 123-4567'"
                  [prefixIcon]="'phone'"
                  [fieldClass]="'form-field'"
                />

                <!-- Save Address Checkbox (authenticated users only) -->
                @if (!isGuest()) {
                  <div class="save-address-container">
                    <mat-checkbox formControlName="saveAddress">
                      Save this delivery address to my profile
                    </mat-checkbox>
                  </div>
                }
              } @else {
                <div class="using-saved-address-note">
                  <mat-icon>local_shipping</mat-icon>
                  <span>Using selected saved address for this order</span>
                </div>
              }
            </div>
          </form>
        </div>

        <!-- Right Column: Order Summary -->
        <div class="order-summary-section">
          <h2>Order Summary</h2>

          <!-- Order Items -->
          <div class="order-items">
            @for (item of cartItems(); track item.cartItem.productId) {
              <div class="order-item">
                <div class="item-image">
                  @if (item.product.imageUrls && item.product.imageUrls.length > 0) {
                    <img 
                      [src]="item.product.imageUrls[0]" 
                      [alt]="item.product.name">
                  }
                </div>
                <div class="item-details">
                  <h3>{{ item.product.name }}</h3>
                  <p class="item-quantity">Qty: {{ item.cartItem.quantity }}</p>
                </div>
                <div class="item-price">
                  {{ item.product.price * item.cartItem.quantity | currency }}
                </div>
              </div>
            }
          </div>

          <!-- Order Totals -->
          <app-order-summary
            [title]="''"
            [summaryLines]="summaryLines()"
            [total]="total()">
            <!-- Error Message -->
            @if (error()) {
              <div class="error-message">
                <mat-icon>error</mat-icon>
                <span>{{ error() }}</span>
              </div>
            }

            <!-- Actions -->
            <div class="checkout-actions">
              <button 
                mat-stroked-button 
                (click)="backToCart()"
                [disabled]="submitting()">
                Back to Cart
              </button>
              <button 
                mat-raised-button 
                color="primary"
                (click)="placeOrder()"
                [disabled]="checkoutForm.invalid || submitting()">
                @if (submitting()) {
                  <mat-spinner diameter="20"></mat-spinner>
                  <span>Processing...</span>
                } @else {
                  <span>Place Order</span>
                }
              </button>
            </div>
          </app-order-summary>
        </div>
      </div>
    }
  </div>
</div>
